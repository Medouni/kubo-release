#!/bin/bash -e

main() {
  <% if_p('cloud-provider') do |cloud_provider| %>
    cloud_provider="<%= cloud_provider %>"
  <% end %>

  if [[ "gce" == "$cloud_provider" ]]; then
    # The hostname needs to be set to the instance name so the gce cloud provider can manage the instance
    hostname_override=$(curl http://metadata.google.internal/computeMetadata/v1/instance/name -H "Metadata-Flavor: Google")
  elif [[ "azure" == "$cloud_provider" ]]; then
    # K8s Azure provider assumes  the hostname == nodename and is required to resolve the VM instance ID
    hostname_override=
  else
    hostname_override=<%= spec.ip %>
  fi

  echo $hostname_override

  sed -i "s|HOSTNAMEOVERRIDE|$hostname_override|g"  /var/vcap/jobs/kube-proxy/config/config.yml
}

