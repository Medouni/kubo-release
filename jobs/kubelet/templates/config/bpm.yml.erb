---
<%
  iaas = nil
if_p('cloud-provider') do |cloud_provider|
  iaas = cloud_provider
end
if_link('cloud-provider') do |cloud_provider|
  cloud_config="/var/vcap/jobs/kubelet/config/cloud-provider.ini"
  cloud_provider.if_p('cloud-provider.gce.service_key') do |service_key|
    export GOOGLE_APPLICATION_CREDENTIALS="/var/vcap/jobs/kubelet/config/service_key.json"
  end
  cloud_provider.if_p('cloud-provider.aws.access_key_id') do |access_key_id|
    export AWS_ACCESS_KEY_ID = access_key_id
  end
  cloud_provider.if_p('cloud-provider.aws.secret_access_key') do |secret_access_key|
    export AWS_SECRET_ACCESS_KEY= secret_access_key
  end
end
hostname_override = spec.ip
if "gce" == cloud_provider do
  # The hostname needs to be set to the instance name so the gce cloud provider can manage the instance
  hostname_override=`curl http://metadata.google.internal/computeMetadata/v1/instance/name -H "Metadata-Flavor: Google"`
end

%>
processes:
- name: kubelet
  executable: /var/vcap/packages/bin/kubelet
  args:
    --allow-privileged=<%= p('allow_privileged') %> \
    <% if include_config -%>--cloud-config=<%= cloud_config %><% end %> \
    <% if !iaas.nil? -%>--cloud-provider=<%=cloud_provider %><% end %> \
    --cni-bin-dir=/var/vcap/jobs/kubelet/packages/cni/bin \
    --config=/var/vcap/jobs/kubelet/config/kubeletconfig.yml \
    --container-runtime=docker \
    --docker-endpoint="unix:///var/vcap/sys/run/docker/docker.sock" \
    --docker="unix:///var/vcap/sys/run/docker/docker.sock" \
    --hostname-override=$(get_hostname_override) \
    --keep-terminated-pod-volumes=false \
    --kubeconfig=/var/vcap/jobs/kubelet/config/kubeconfig \
    --network-plugin=cni \
    --node-labels=<%= labels %>"$zone_label" \
    --v=<%=p('logging-level') %> \
    <% if_p('kube-reserved') do |kube_reserved| %>--kube-reserved="<%= kube_reserved %>"<% end %> \
    <% if_p('system-reserved') do |system_reserved| %>--system-reserved="<%= system_reserved %>"<% end %> \
    <% if_p('eviction-hard') do |eviction_hard| %>--eviction-hard="<%= eviction_hard %>"<% end %> \
