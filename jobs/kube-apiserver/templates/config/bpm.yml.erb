---
<%
  def get_url(server, port)
    if link('etcd').p('etcd.dns_suffix', false) != false
      node_name = "#{server.name.gsub('_','-')}-#{server.index}"
      return "https://#{node_name}.#{link('etcd').p('etcd.dns_suffix')}:#{port}"
    else
      return "https://#{server.address}:#{port}"
    end
  end

  etcd_endpoints = link('etcd').instances.map { |server| get_url(server, 2379) }.join(",")
%>
processes:
- name: kube-apiserver
  executable: /var/vcap/packages/kubernetes/bin/kube-apiserver
  args:
  - --apiserver-count=<%= link('kube-apiserver').instances.size %>
  - --kubelet-client-key=/var/vcap/jobs/kube-apiserver/config/kubelet-client-key.pem
  - --kubelet-client-certificate=/var/vcap/jobs/kube-apiserver/config/kubelet-client-cert.pem
  - --etcd-servers=<%= etcd_endpoints %>
  - --etcd-cafile=/var/vcap/jobs/kube-apiserver/config/etcd-ca.crt
  - --etcd-certfile=/var/vcap/jobs/kube-apiserver/config/etcd-client.crt
  - --etcd-keyfile=/var/vcap/jobs/kube-apiserver/config/etcd-client.key
  - --service-account-key-file=/var/vcap/jobs/kube-apiserver/config/service-account-public-key.pem
  - --tls-cert-file=/var/vcap/jobs/kube-apiserver/config/kubernetes.pem
  - --tls-private-key-file=/var/vcap/jobs/kube-apiserver/config/kubernetes-key.pem
  - --token-auth-file=/var/vcap/jobs/kube-apiserver/config/tokens.csv
  - --client-ca-file=/var/vcap/jobs/kube-apiserver/config/kubernetes.pem
  - --proxy-client-cert-file=/var/vcap/jobs/kube-apiserver/config/kubernetes.pem
  - --proxy-client-key-file=/var/vcap/jobs/kube-apiserver/config/kubernetes-key.pem
  - --requestheader-client-ca-file=/var/vcap/jobs/kube-apiserver/config/kubernetes.pem
  <% p('args').each do |arg|
    argString = "--#{arg["flag"]}"
    if arg["value"]
      if arg["value"].is_a? Array
        values = arg["value"].join(",")
      else
        values = arg["value"]
      end
      argString += "=#{values}"
    end
  %>
  - <%= argString %>
  <% end %>
  env:
    <% if_p('no_proxy') do |no_proxy| %>
    NO_PROXY: <%= no_proxy %>
    no_proxy: <%= no_proxy %>
    <% end %>
    <% if_p('https_proxy') do |https_proxy| %>
    HTTPS_PROXY: <%= https_proxy %>
    https_proxy: <%= https_proxy %>
    <% end %>
    <% if_p('http_proxy') do |http_proxy| %>
    HTTP_PROXY: <%= http_proxy %>
    http_proxy: <%= http_proxy %>
    <% end %>
    <% if_link('cloud-provider') do |cloud_provider| %>
    <% cloud_provider.if_p('cloud-provider.gce.service_key') do |service_key| %>
    GOOGLE_APPLICATION_CREDENTIALS: /var/vcap/jobs/kube-apiserver/config/service_key.json
    <% end %>
    <% cloud_provider.if_p('cloud-provider.aws.access_key_id') do |access_key_id| %>
    AWS_ACCESS_KEY_ID: <%= access_key_id %>
    <% end %>
    <% cloud_provider.if_p('cloud-provider.aws.secret_access_key') do |secret_access_key| %>
    AWS_SECRET_ACCESS_KEY: <%= secret_access_key %>
    <% end %>
    <% end %>
