---
<%
  def get_url(server, port)
    if link('etcd').p('etcd.dns_suffix', false) != false
      node_name = "#{server.name.gsub('_','-')}-#{server.index}"
      return "https://#{node_name}.#{link('etcd').p('etcd.dns_suffix')}:#{port}"
    else
      return "https://#{server.address}:#{port}"
    end
  end

  etcd_servers_property_set=FALSE
  if_p("k8s-args.etcd-servers") do |dummy|
    etcd_servers_property_set=TRUE
  end

  if !etcd_servers_property_set
    etcd_endpoints = link('etcd').instances.map { |server| get_url(server, 2379) }.join(",")
  end
%>
processes:
- name: kube-apiserver
  executable: /var/vcap/packages/kubernetes/bin/kube-apiserver
  args: <% if_p('k8s-args') do
    p('k8s-args').each do |flag, value|
      if_p('k8s-args.'+flag) do |v|
        argString = "--#{flag}"
        if v
          if v.is_a? Array
            values = v.join(",")
          elsif v.is_a? Hash
            values = v.map { |k,v| "#{k}=#{v}" }.join(",")
          else
            values = v
          end
          argString += "=#{values}" %>
  - <%= '"' + argString + '"' %><%
        end
      end
    end
  end %>
  - --apiserver-count=<%= link('kube-apiserver').instances.size %>
  <% if_link('cloud-provider') do |cloud_provider| %>
  - --cloud-provider=<%= cloud_provider.p('cloud-provider.type') %>
  - --cloud-config=/var/vcap/jobs/kube-apiserver/config/cloud-provider.ini
  <% end %>
  <% if !etcd_servers_property_set %>
  - --etcd-servers=<%= etcd_endpoints %>
  <% end %>
  env:
    <% if_p('no_proxy') do |no_proxy| %>
    NO_PROXY: <%= no_proxy %>
    no_proxy: <%= no_proxy %>
    <% end %>
    <% if_p('https_proxy') do |https_proxy| %>
    HTTPS_PROXY: <%= https_proxy %>
    https_proxy: <%= https_proxy %>
    <% end %>
    <% if_p('http_proxy') do |http_proxy| %>
    HTTP_PROXY: <%= http_proxy %>
    http_proxy: <%= http_proxy %>
    <% end %>
    <% if_link('cloud-provider') do |cloud_provider| %>
    <% cloud_provider.if_p('cloud-provider.gce.service_key') do |service_key| %>
    GOOGLE_APPLICATION_CREDENTIALS: /var/vcap/jobs/kube-apiserver/config/service_key.json
    <% end %>
    <% cloud_provider.if_p('cloud-provider.aws.access_key_id') do |access_key_id| %>
    AWS_ACCESS_KEY_ID: <%= access_key_id %>
    <% end %>
    <% cloud_provider.if_p('cloud-provider.aws.secret_access_key') do |secret_access_key| %>
    AWS_SECRET_ACCESS_KEY: <%= secret_access_key %>
    <% end %>
    <% end %>
